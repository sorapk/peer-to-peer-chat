(this["webpackJsonppeer-to-peer-chat"]=this["webpackJsonppeer-to-peer-chat"]||[]).push([[0],{101:function(e,n,t){"use strict";t.r(n);var r=t(1),o=t.n(r),a=t(44),c=t.n(a),s=(t(52),t(24)),i=t(45),l=t(3),u=t.n(l),p=t(4),d=t(5),f=(t(54),t(23)),m=t(28),g=t.n(m),v=t(27),x={firestore:f.firestore,auth:f.auth,initializeApp:f.initializeApp},h=function(){var e=Object(p.a)(u.a.mark((function e(){var n,t,r,o,a,c,s,l;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=JSON.parse('{"apiKey":"AIzaSyAHH_MAChQ_IBDZpr9-56HcHIB75DVVKH0","authDomain":"peer-to-peer-chat.firebaseapp.com","databaseURL":"https://peer-to-peer-chat.firebaseio.com","projectId":"peer-to-peer-chat","storageBucket":"peer-to-peer-chat.appspot.com","messagingSenderId":"445910441383","appId":"1:445910441383:web:8c62e1574f618d33c02a82","measurementId":"G-Z2GVLXMPT8"}'),x.initializeApp(n),t=x.firestore(),console.log("initializing firebase"),e.next=6,x.auth().signInAnonymously();case 6:return r=e.sent,console.log("user auth uid:",r.user.uid),e.next=10,t.collection("user").doc(r.user.uid).get();case 10:if(o=e.sent,console.log("==== user existing info ===="),console.log("user has existing info status:",o.exists),console.log("user existing info id:",o.id),console.log("user existing info:",o.data()),o&&o.exists){e.next=18;break}return e.next=18,t.collection("user").doc(r.user.uid).set({authenInfo:null,friendList:[],roomOwner:[],roomMemeber:[]});case 18:return e.next=20,t.collection("user").doc(r.user.uid);case 20:return a=e.sent,console.log("userRef:",a),console.log("userRef id:",a.id),c=function(e){var n=e.seconds,t=e.nanoseconds;return new x.firestore.Timestamp(n,t).toMillis()},s=function(){var e=Object(p.a)(u.a.mark((function e(n){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.doc("connection/".concat(n));case 2:return r=e.sent,e.next=5,t.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(n){var t,o,a,s,i,l,p,d,f,m,g,v,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(r);case 2:if(!(t=e.sent).exists){e.next=20;break}if(o=t.data(),a=o.callerPayload,s=o.from,i=o.lastUpdated,l=t.data(),p=l.callerMsgInd,d=l.callerMsgCnt,f=x.firestore.Timestamp.now().toMillis(),m=c(i),g=f-m>=3e4,console.log("incoming caller msg:",{callerPayload:a,callerMsgInd:p,callerMsgCnt:d,from:s,lastUpdateMili:m,currentTime:f,expired:g}),!(p>=d||g)){e.next=13;break}return console.log("no caller msg to process"),e.abrupt("return",null);case 13:for(v=Object.assign({},a),h=p;p<d;)delete a[p++];return console.log("updating remote copy:",{callerPayload:a,callerMsgInd:p}),e.next=19,n.update(r,{callerPayload:a,callerMsgInd:p,callerMsgDiff:d-p,lastUpdated:x.firestore.Timestamp.now().toDate()});case 19:return e.abrupt("return",{callerPayload:v,callerMsgInd:h,callerMsgCnt:d,from:s});case 20:return e.abrupt("return",null);case 21:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),l=function(){var e=Object(p.a)(u.a.mark((function e(n){var r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.doc("connection/".concat(n));case 2:return r=e.sent,e.next=5,t.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(n){var t,o,a,s,i,l,p,d,f,m,g,v,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(r);case 2:if(!(t=e.sent).exists){e.next=20;break}if(o=t.data(),a=o.calleePayload,s=o.to,i=o.lastUpdated,l=t.data(),p=l.calleeMsgInd,d=l.calleeMsgCnt,f=x.firestore.Timestamp.now().toMillis(),m=c(i),g=f-m>=3e4,console.log("incoming callee msg:",{calleePayload:a,calleeMsgInd:p,calleeMsgCnt:d,to:s,lastUpdateMili:m,currentTime:f,expired:g}),!(p>=d||g)){e.next=13;break}return console.log("no callee msg to process"),e.abrupt("return",null);case 13:for(v=Object.assign({},a),h=p;p<d;)delete a[p++];return console.log("updating remote copy:",{calleePayload:a,calleeMsgInd:p}),e.next=19,n.update(r,{calleePayload:a,calleeMsgInd:p,calleeMsgDiff:d-p,lastUpdated:x.firestore.Timestamp.now().toDate()});case 19:return e.abrupt("return",{calleePayload:v,calleeMsgInd:h,calleeMsgCnt:d,to:s});case 20:return e.abrupt("return",null);case 21:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),e.abrupt("return",{userID:function(){return a.id},userInfo:function(){},on:function(e,n,t){},onCallerMsg:function(e,n,r){t.collection("connection").where("roomID","==",e).where("to","==",a.id).where("callerMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(p.a)(u.a.mark((function e(n){var t,o,a,c,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.exists){e.next=9;break}return e.next=3,s(n.id);case 3:if(!(t=e.sent)){e.next=9;break}return o=t.callerPayload,a=t.callerMsgInd,c=t.callerMsgCnt,i=t.from,console.log("processing payload:",{callerPayload:o,callerMsgInd:a,callerMsgCnt:c}),e.next=9,r(o,a,c,i);case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}())}))},onCalleeMsg:function(e,n,r){t.collection("connection").where("roomID","==",e).where("from","==",a.id).where("calleeMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(p.a)(u.a.mark((function e(n){var t,o,a,c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.exists){e.next=8;break}return e.next=3,l(n.id);case 3:if(!(t=e.sent)){e.next=8;break}return o=t.calleePayload,a=t.calleeMsgInd,c=t.calleeMsgCnt,s=t.to,e.next=8,r(o,a,c,s);case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}())}))},sendCallerAResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,r){var o,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[r,a.id].sort().join("_"),console.log("responding to caller:",r),console.log("connection id:",o),console.log({data:n}),e.next=6,t.doc("connection/".concat(o));case 6:return c=e.sent,e.next=9,t.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(t){var r,o,a,s,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(c);case 2:if(!(r=e.sent).exists){e.next=9;break}return o=r.data(),a=o.calleePayload,s=o.calleeMsgCnt,i=o.calleeMsgInd,a[s]=n,s++,e.next=9,t.update(c,{calleeMsgCnt:s,calleePayload:a,calleeMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate()});case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),sendCalleeAResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,r){var o,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[r,a.id].sort().join("_"),console.log("responding to callee:",r),console.log("connection id:",o),console.log({data:n}),e.next=6,t.doc("connection/".concat(o));case 6:return c=e.sent,e.next=9,t.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(t){var r,o,a,s,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(c);case 2:if(!(r=e.sent).exists){e.next=9;break}return o=r.data(),a=o.callerPayload,s=o.callerMsgCnt,i=o.callerMsgInd,a[s]=n,s++,e.next=9,t.update(c,{callerMsgCnt:s,callerPayload:a,callerMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate()});case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),initiateConnection:function(){var e=Object(p.a)(u.a.mark((function e(n,r,o){var c,s,i=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,c=[o,a.id].sort().join("_"),console.log("initiating connnection from:",a.id),console.log("connection id:",c),console.log({roomID:n,message:r,to:o,from:a.id}),e.next=7,t.doc("connection/".concat(c));case 7:return s=e.sent,e.next=10,t.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(t){var c,l,p,d,f;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(s);case 2:if(c=e.sent,l=!0===c.exists?c.data():null,p=!1,l&&(d=i.firebaseTimeToTimestamp(l.lastUpdated),f=x.firestore.Timestamp.now().toMillis(),p=f-d>=3e4,console.log("prior control expire status:",p,", milisecond elapsed:",f-d)),null!==l&&!p){e.next=10;break}return console.log("creating new connection"),e.next=10,t.set(s,{from:a.id,to:o,roomID:n,message:r,callerMsgCnt:1,callerMsgInd:0,callerMsgDiff:1,callerPayload:{0:b},calleeMsgCnt:0,calleeMsgInd:0,calleeMsgDiff:0,calleePayload:{},lastUpdated:x.firestore.Timestamp.now().toDate()});case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("msg send error:",e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(n,t,r){return e.apply(this,arguments)}}(),emit:function(){var e=Object(p.a)(u.a.mark((function e(n,t,r,o){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}(),respond:function(){var e=Object(p.a)(u.a.mark((function e(n,t,r,o){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}(),sendAndWaitForResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,r,o,c){var s,i,l,p,d,f,m,g=arguments;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=g.length>4&&void 0!==g[4]?g[4]:5e3,console.log("creating message for:",a.id),console.log({roomID:n,message:r,payload:o,from:a.id,to:c,timeout:s}),e.prev=3,e.next=6,t.doc("msg-queue/".concat(a.id)).set({from:a.id,response:null,msgRead:!1,to:c,message:r,roomID:n,payload:o});case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("msg send error:",e.t0);case 11:return i="timeout",l=null,p=!0,d=new Promise((function(e,n){l=t.doc("msg-queue/".concat(a.id)).onSnapshot((function(n){var t=n.data(),r=t.msgRead,o=t.response;!0===r&&(l(),console.log("recieved response:",n.data()),p=!1,e(o))}))})),f=new Promise((function(e,n){return setTimeout((function(){p?(console.error("Promise Timeout"),console.log("unsub listener"),l(),n(i)):e()}),s)})),e.next=18,Promise.race([d,f]);case 18:return m=e.sent,e.abrupt("return",m);case 20:case"end":return e.stop()}}),e,null,[[3,8]])})));return function(n,t,r,o){return e.apply(this,arguments)}}(),joinRoom:function(){var e=Object(p.a)(u.a.mark((function e(n){var r,o,c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("joining room:",n),!n){e.next=23;break}return e.next=5,t.doc("room/".concat(n));case 5:return r=e.sent,e.next=8,r.get();case 8:if(!(o=e.sent)||!o.exists){e.next=22;break}return console.log("userRef in room:",a.id),c=Object(i.a)({},"user."+a.id,x.firestore.Timestamp.now().toDate()),console.log("room data:",o.data()),console.log("msg queue data:",c),e.next=16,r.update(c);case 16:return e.next=18,r.get();case 18:return s=e.sent,e.abrupt("return",s.data());case 22:console.log("room doesn't exist:",n);case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),console.error("join room exception:",e.t0);case 28:return e.abrupt("return",null);case 29:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(n){return e.apply(this,arguments)}}(),createRoom:function(){var e=Object(p.a)(u.a.mark((function e(){var n,r;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.collection("room").add({user:{},created:x.firestore.Timestamp.now().toDate()});case 3:return n=e.sent,e.next=6,a.update({roomOwner:x.firestore.FieldValue.arrayUnion(n.id)});case 6:return r=e.sent,console.log("create room id:",n.id),console.log("create room info:",r),e.abrupt("return",n.id);case 12:e.prev=12,e.t0=e.catch(0),console.error("create room exception:",e.t0);case 15:return e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),firebaseTimeToTimestamp:c});case 27:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),b="initiate",w=function(e){this.id=e,this.state="not-connected",this.peer=null},y=function(e){var n=Object(r.useRef)();return Object(r.useEffect)((function(){e.peer.on("stream",(function(e){console.log("peer stream:",e),n.current.srcObject=e}))}),[]),o.a.createElement("div",null,o.a.createElement("video",{playsInline:!0,autoPlay:!0,ref:n}))},M=Object(d.g)((function(e){var n=Object.assign({},e),t=Object(r.useRef)(),a=n.match.params.id,c={height:window.innerHeight/2,width:window.innerWidth/2};console.log("roomID--\x3e",a,"props --\x3e",n);var i=n.userDB,l=Object(r.useRef)(),d=Object(r.useState)({}),f=Object(s.a)(d,2),m=f[0],v=f[1];Object(r.useEffect)((function(){void 0!==i&&(void 0===l.current&&(l.current={}),navigator.mediaDevices.getUserMedia({video:c,audio:!1}).then(x))}),[]);var x=function(){var e=Object(p.a)(u.a.mark((function e(r){var o,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.current.srcObject=r,e.next=3,i.joinRoom(a);case 3:for(c in null===(o=e.sent)&&(alert("This room does not exist."),n.history.push("/")),o.user)c!==i.userID()&&(l.current[c]=new w(c));v({}),i.onCallerMsg(a,"request-connect",function(){var e=Object(p.a)(u.a.mark((function e(n,t,o,a){var c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t<o)){e.next=14;break}if(c=n[t++],void 0===l.current[a]&&(l.current[a]=new w(a)),"not-connected"!==(s=l.current[a]).state||c!==b){e.next=11;break}return s.state="initiated",console.log("initiation recieved from:",a),e.next=9,i.sendCallerAResponse("callee-accept",a);case 9:e.next=12;break;case 11:"initiated"===s.state?(s.state="connecting",console.log("recieved offer recieved from:",a),console.log("offer:",c),s.peer=j(c,a,r,(function(e){i.sendCallerAResponse(e,a)})),s.peer.on("connect",(function(){console.log("connection connected:",l.current[a].id),l.current[a].state="connected",v({})})),s.peer.on("close",(function(){l.current[a].state="not-connected",console.log("connection closed:",l.current[a].id),l.current[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})})),s.peer.on("error",(function(e){console.log("connection error:",l.current[a].id,e),l.current[a].state="failed",l.current[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})})),s.peer.signal(c)):"connecting"===s.state||"connected"===s.state?(console.log("recieved ICE recieved from:",a),console.log("ICE:",c),s.peer.signal(c)):(s.state="failed",s.peer&&(s.peer.destroy(),s.peer=void 0));case 12:e.next=0;break;case 14:v({});case 15:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}()),i.onCalleeMsg(a,"response-signal",function(){var e=Object(p.a)(u.a.mark((function e(n,t,o,a){var c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(;t<o;)c=n[t++],void 0===l.current[a]&&(l.current[a]=new w(a)),"not-connected"===(s=l.current[a]).state&&"callee-accept"===c?(s.state="initiated",console.log("callee accepted call:",a),s.peer=k(a,r,(function(e){i.sendCalleeAResponse(e,a)})),s.peer.on("connect",(function(){l.current[a].state="connected",console.log("connection connect:",l.current[a].id),v({})})),s.peer.on("close",(function(){console.log("connection cosed:",l.current[a].id),l.current[a].state="not-connected",l.current[a].peer&&(m[a].peer.destroy(),m[a].peer=void 0),v({})})),s.peer.on("error",(function(e){console.log("connection error:",l.current[a].id,e),l.current[a].state="failed",l.currentom[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})}))):"initiated"===s.state||"connecting"===s.state||"connected"===s.state?("initiated"===s.state&&(s.state="connecting"),console.log("recieved answer/ICE recieved from callee:",a),console.log("callee data:",c),s.peer.signal(c)):(s.state="failed",s.peer&&(s.peer.destroy(),s.peer=void 0));v({});case 2:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}()),h(r,o);case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),h=function(e,n){console.log({roomInfo:n});var t=n.user,r=i.userID(),o=i.firebaseTimeToTimestamp(t[r]);for(var c in console.log("current user joined room timestamp:",o),t){var s=i.firebaseTimeToTimestamp(t[c]);c!==r&&s<o&&M(c,e,a)}},M=function(e,n,t){i.initiateConnection(t,"initiate-connection",e)},k=function(e,n,t){var r=new g.a({initiator:!0,trickle:!1,stream:n});return console.log("peer created --\x3e",r),r.on("signal",(function(n){console.log("signal created for:",e,n),t(n)})),r},j=function(e,n,t,r){var o=new g.a({initiator:!1,trickle:!1,stream:t});return o.on("signal",(function(e){console.log("returning signal created for",n,e),r(e)})),o},I=[];for(var O in l.current)l.current[O].peer&&I.push(l.current[O].peer);var D={failed:"red",initiated:"orange","not-connected":"grey",connecting:"yellow",connected:"green"},T=l.current?Object.keys(l.current).map((function(e){return o.a.createElement("li",{key:e},"User ID: ",e," Status:"," ",o.a.createElement("span",{style:{backgroundColor:D[l.current[e].state]}},l.current[e].state))})):null;return console.log("peer list:",I),console.log(l.current),o.a.createElement("div",null,o.a.createElement("h3",null,"My User ID: ",i?i.userID():void 0),o.a.createElement("video",{muted:!0,ref:t,autoPlay:!0,playsInline:!0}),o.a.createElement("h3",null,"User In Room:"),o.a.createElement("ul",null,T),o.a.createElement("hr",null),I.map((function(e,n){return o.a.createElement("div",{key:n},n,o.a.createElement(y,{peer:e}))})))})),k=function(e){var n=Object(r.useState)(),t=Object(s.a)(n,2),a=t[0],c=t[1],i=Object(r.useState)(null),l=Object(s.a)(i,2),f=l[0],m=l[1];Object(r.useEffect)((function(){Object(p.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h();case 2:n=e.sent,c(n);case 4:case"end":return e.stop()}}),e)})))()}),[]);var g=function(){var e=Object(p.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.createRoom();case 2:n=e.sent,m("/room/".concat(n));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return o.a.createElement(v.a,{basename:"/"},o.a.createElement(o.a.StrictMode,null,o.a.createElement("button",{onClick:g},"Create Room"),f?o.a.createElement(d.a,{to:f}):void 0,o.a.createElement(d.d,null,o.a.createElement(d.b,{path:"/room/:id",component:function(){return o.a.createElement(M,Object.assign({},e,{userDB:a}))}}))))};c.a.render(o.a.createElement(k,null),document.getElementById("root"))},47:function(e,n,t){e.exports=t(101)},52:function(e,n,t){},54:function(e,n,t){},88:function(e,n){},90:function(e,n){}},[[47,1,2]]]);
//# sourceMappingURL=main.5dc4a334.chunk.js.map