(this["webpackJsonppeer-to-peer-chat"]=this["webpackJsonppeer-to-peer-chat"]||[]).push([[0],{103:function(e,t,n){"use strict";n.r(t);var r,a=n(1),o=n.n(a),c=n(44),s=n.n(c),i=(n(54),n(3)),l=n.n(i),u=n(4),p=n(22),f=n(5),d=(n(56),n(28)),m=n.n(d),g=n(24),h=n(45),v=n(25),x={firestore:v.firestore,auth:v.auth,initializeApp:v.initializeApp},E=function(){var e=Object(u.a)(l.a.mark((function e(){var t,n,r,a,o,c,s,i,p,f;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.next=2;break;case 2:return t='"{"apiKey":"AIzaSyAHH_MAChQ_IBDZpr9-56HcHIB75DVVKH0","authDomain":"peer-to-peer-chat.firebaseapp.com","databaseURL":"https://peer-to-peer-chat.firebaseio.com","projectId":"peer-to-peer-chat","storageBucket":"peer-to-peer-chat.appspot.com","messagingSenderId":"445910441383","appId":"1:445910441383:web:8c62e1574f618d33c02a82","measurementId":"G-Z2GVLXMPT8"}"'.slice(1,-1),n=JSON.parse(t),x.initializeApp(n),r=x.firestore(),e.next=8,x.auth().signInAnonymously();case 8:if(null!==(a=e.sent)&&null!==a.user){e.next=11;break}return e.abrupt("return");case 11:return console.log("user auth uid:",a.user.uid),e.next=14,r.collection("user").doc(a.user.uid).get();case 14:if(o=e.sent,console.log("==== user existing info ===="),console.log("user has existing info status:",o.exists),console.log("user existing info id:",o.id),console.log("user existing info:",o.data()),o&&o.exists){e.next=22;break}return e.next=22,r.collection("user").doc(a.user.uid).set({authenInfo:null,friendList:[],roomOwner:[],roomMemeber:[]});case 22:return e.next=24,r.collection("user").doc(a.user.uid);case 24:return c=e.sent,console.log("userRef:",c),console.log("userRef id:",c.id),s=function(e){var t=e.seconds,n=e.nanoseconds;return new x.firestore.Timestamp(t,n).toMillis()},i=function(){var e=Object(u.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.doc("connection/".concat(t));case 2:return n=e.sent,e.next=5,r.runTransaction(function(){var e=Object(u.a)(l.a.mark((function e(t){var r,a,o,c,i,u,p,f,d,m,g,h;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(n);case 2:if(!(r=e.sent).exists){e.next=21;break}if(a=r.data(),o=a.callerPayload,c=a.from,i=a.lastUpdated,u=a.callerMsgInd,p=a.callerMsgCnt,f=x.firestore.Timestamp.now().toMillis(),d=s(i),m=f-d>=3e4,console.log("incoming caller msg:",{callerPayload:o,callerMsgInd:u,callerMsgCnt:p,from:c,lastUpdateMili:d,currentTime:f,expired:m}),!(u>=p||m)){e.next=14;break}return console.log("no caller msg to process"),e.abrupt("return",null);case 14:for(g=Object.assign({},o),h=u;u<p;)delete o[u++];return console.log("updating remote copy:",{callerPayload:o,callerMsgInd:u}),e.next=20,t.update(n,{callerPayload:o,callerMsgInd:u,callerMsgDiff:p-u,lastUpdated:x.firestore.Timestamp.now().toDate()});case 20:return e.abrupt("return",{callerPayload:g,callerMsgInd:h,callerMsgCnt:p,from:c});case 21:return e.abrupt("return",null);case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),p=function(){var e=Object(u.a)(l.a.mark((function e(t){var n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.doc("connection/".concat(t));case 2:return n=e.sent,e.next=5,r.runTransaction(function(){var e=Object(u.a)(l.a.mark((function e(t){var r,a,o,c,i,u,p,f,d,m,g,h;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(n);case 2:if(!(r=e.sent).exists){e.next=20;break}if(a=r.data(),o=a.calleePayload,c=a.to,i=a.lastUpdated,u=a.calleeMsgInd,p=a.calleeMsgCnt,f=x.firestore.Timestamp.now().toMillis(),d=s(i),m=f-d>=3e4,console.log("incoming callee msg:",{calleePayload:o,calleeMsgInd:u,calleeMsgCnt:p,to:c,lastUpdateMili:d,currentTime:f,expired:m}),!(u>=p||m)){e.next=13;break}return console.log("no callee msg to process"),e.abrupt("return",null);case 13:for(g=Object.assign({},o),h=u;u<p;)delete o[u++];return console.log("updating remote copy:",{calleePayload:o,calleeMsgInd:u}),e.next=19,t.update(n,{calleePayload:o,calleeMsgInd:u,calleeMsgDiff:p-u,lastUpdated:x.firestore.Timestamp.now().toDate()});case 19:return e.abrupt("return",{calleePayload:g,calleeMsgInd:h,calleeMsgCnt:p,to:c});case 20:return e.abrupt("return",null);case 21:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),f={userID:function(){return c.id},onCallerMsg:function(e,t,n){r.collection("connection").where("roomID","==",e).where("to","==",c.id).where("callerMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(u.a)(l.a.mark((function e(t){var r,a,o,c,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.exists){e.next=9;break}return e.next=3,i(t.id);case 3:if(!(r=e.sent)){e.next=9;break}return a=r.callerPayload,o=r.callerMsgInd,c=r.callerMsgCnt,s=r.from,console.log("processing payload:",{callerPayload:a,callerMsgInd:o,callerMsgCnt:c}),e.next=9,n(a,o,c,s);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}))},onCalleeMsg:function(e,t,n){r.collection("connection").where("roomID","==",e).where("from","==",c.id).where("calleeMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(u.a)(l.a.mark((function e(t){var r,a,o,c,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.exists){e.next=8;break}return e.next=3,p(t.id);case 3:if(!(r=e.sent)){e.next=8;break}return a=r.calleePayload,o=r.calleeMsgInd,c=r.calleeMsgCnt,s=r.to,e.next=8,n(a,o,c,s);case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}))},sendCallerAResponse:function(){var e=Object(u.a)(l.a.mark((function e(t,n){var a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[n,c.id].sort().join("_"),console.log("responding to caller:",n),console.log("connection id:",a),console.log({data:t}),e.next=6,r.doc("connection/".concat(a));case 6:return o=e.sent,e.next=9,r.runTransaction(function(){var e=Object(u.a)(l.a.mark((function e(n){var r,a,c,s,i,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(o);case 2:if(!(r=e.sent).exists){e.next=11;break}return a=r.data(),c=a.calleePayload,s=a.calleeMsgCnt,i=a.calleeMsgInd,u=x.firestore.FieldValue.increment((new TextEncoder).encode(JSON.stringify(t)).length),c[s]=t,s++,e.next=11,n.update(o,{calleeMsgCnt:s,calleePayload:c,calleeMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate(),payloadByteUsed:u});case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),sendCalleeAResponse:function(){var e=Object(u.a)(l.a.mark((function e(t,n){var a,o;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=[n,c.id].sort().join("_"),console.log("responding to callee:",n),console.log("connection id:",a),console.log({data:t}),e.next=6,r.doc("connection/".concat(a));case 6:return o=e.sent,e.next=9,r.runTransaction(function(){var e=Object(u.a)(l.a.mark((function e(n){var r,a,c,s,i,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(o);case 2:if(!(r=e.sent).exists){e.next=11;break}return a=r.data(),c=a.callerPayload,s=a.callerMsgCnt,i=a.callerMsgInd,u=x.firestore.FieldValue.increment((new TextEncoder).encode(JSON.stringify(t)).length),c[s]=t,s++,e.next=11,n.update(o,{callerMsgCnt:s,callerPayload:c,callerMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate(),payloadByteUsed:u});case 11:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),initiateConnection:function(){var e=Object(u.a)(l.a.mark((function e(t,n,a){var o,s,i=this;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=[a,c.id].sort().join("_"),console.log("initiating connnection from:",c.id),console.log("connection id:",o),console.log({roomID:t,message:n,to:a,from:c.id}),e.next=7,r.doc("connection/".concat(o));case 7:return s=e.sent,e.next=10,r.runTransaction(function(){var e=Object(u.a)(l.a.mark((function e(r){var o,u,p,f,d;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get(s);case 2:if(o=e.sent,u=!0===o.exists?o.data():null,p=!1,u&&(f=i.firebaseTimeToTimestamp(u.lastUpdated),d=x.firestore.Timestamp.now().toMillis(),p=d-f>=3e4,console.log("prior control expire status:",p,", milisecond elapsed:",d-f)),null!==u&&!p){e.next=10;break}return console.log("creating new connection"),e.next=10,r.set(s,{from:c.id,to:a,roomID:t,message:n,callerMsgCnt:1,callerMsgInd:0,callerMsgDiff:1,callerPayload:{0:"initiate"},calleeMsgCnt:0,calleeMsgInd:0,calleeMsgDiff:0,calleePayload:{},payloadByteUsed:0,lastUpdated:x.firestore.Timestamp.now().toDate()});case 10:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("msg send error:",e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(t,n,r){return e.apply(this,arguments)}}(),joinRoom:function(){var e=Object(u.a)(l.a.mark((function e(t){var n,a,o,s;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("joining room:",t),!t){e.next=23;break}return e.next=5,r.doc("room/".concat(t));case 5:return n=e.sent,e.next=8,n.get();case 8:if(!(a=e.sent)||!a.exists){e.next=22;break}return console.log("userRef in room:",c.id),o=Object(h.a)({},"user."+c.id,x.firestore.Timestamp.now().toDate()),console.log("room data:",a.data()),console.log("msg queue data:",o),e.next=16,n.update(o);case 16:return e.next=18,n.get();case 18:return s=e.sent,e.abrupt("return",s.data());case 22:console.log("room doesn't exist:",t);case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),console.error("join room exception:",e.t0);case 28:return e.abrupt("return",null);case 29:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(t){return e.apply(this,arguments)}}(),createRoom:function(){var e=Object(u.a)(l.a.mark((function e(){var t,n;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.collection("room").add({user:{},created:x.firestore.Timestamp.now().toDate()});case 3:return t=e.sent,e.next=6,c.update({roomOwner:x.firestore.FieldValue.arrayUnion(t.id)});case 6:return n=e.sent,console.log("create room id:",t.id),console.log("create room info:",n),e.abrupt("return",t.id);case 12:e.prev=12,e.t0=e.catch(0),console.error("create room exception:",e.t0);case 15:return e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),firebaseTimeToTimestamp:s},e.abrupt("return",f);case 32:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),b=n(46),T=n(47);!function(e){e.PEER_STATE_0="not-connected",e.PEER_STATE_1="initiated",e.PEER_STATE_2="connecting",e.PEER_STATE_3="connected",e.PEER_STATE_4="failed"}(r||(r={}));var y=function(){function e(t){Object(b.a)(this,e),this.id=void 0,this.state=void 0,this.peer=void 0,this.id=t,this.state=r.PEER_STATE_0,this.peer=null}return Object(T.a)(e,[{key:"__initPeer",value:function(e,t,n,a){var o=this,c={initiator:"initiator"===t,trickle:!1,stream:e},s=new m.a(c);s.on("signal",(function(e){n(e)})),s.on("connect",(function(){console.log("connection establised:",o.id),o.state=r.PEER_STATE_3,a("connect")})),s.on("close",(function(){o.state=r.PEER_STATE_0,console.log("connection closed:",o.id),o.__peerCleanUp(),a("disconnect")})),s.on("error",(function(e){console.log("connection error:",o.id,e),o.state=r.PEER_STATE_4,a("error")})),this.peer=s}},{key:"__peerProcessSignal",value:function(e){this.peer&&this.peer.signal(e)}},{key:"__peerCleanUp",value:function(){this.peer&&(this.peer.destroy(),this.peer=null)}},{key:"processCallerPayload",value:function(e,t,n,a,o){this.state===r.PEER_STATE_0?(this.state=r.PEER_STATE_1,console.log("initiation recieved from:",t)):this.state===r.PEER_STATE_1?(this.state=r.PEER_STATE_2,console.log("recieved offer recieved from:",t),console.log("offer:",n),this.__initPeer(e,"non-initiator",a,o),this.__peerProcessSignal(n)):this.state===r.PEER_STATE_2||this.state===r.PEER_STATE_3?(console.log("recieved ICE recieved from:",t),console.log("ICE:",n),this.__peerProcessSignal(n)):(this.state=r.PEER_STATE_4,this.__peerCleanUp())}},{key:"processCalleePayload",value:function(e,t,n,a,o){this.state===r.PEER_STATE_0?(this.state=r.PEER_STATE_1,console.log("callee accepted call:",t),this.__initPeer(e,"initiator",a,o)):this.state===r.PEER_STATE_1||this.state===r.PEER_STATE_2||this.state===r.PEER_STATE_3?(this.state===r.PEER_STATE_1&&(this.state=r.PEER_STATE_2),console.log("recieved answer/ICE recieved from callee:",t),console.log("callee data:",n),this.__peerProcessSignal(n)):(this.state=r.PEER_STATE_4,this.__peerCleanUp())}}]),e}(),w=function(e){var t=Object(a.useRef)();return Object(a.useEffect)((function(){e.peer&&e.peer.on("stream",(function(e){console.log("peer stream:",e),t.current&&(t.current.srcObject=e)}))}),[]),o.a.createElement("div",null,o.a.createElement("video",{playsInline:!0,autoPlay:!0,ref:t}))},_=Object(f.g)((function(e){var t=Object.assign({},e),n=Object(a.useRef)(),r=t.match.params.id,c={height:window.innerHeight/2,width:window.innerWidth/2};console.log("roomID--\x3e",r,"props --\x3e",t);var s=t.connection,i=Object(a.useRef)({}),f=Object(a.useState)({}),d=Object(p.a)(f,2),m=(d[0],d[1]);Object(a.useEffect)((function(){void 0!==s&&navigator.mediaDevices.getUserMedia({video:c,audio:!1}).then(g)}),[]);var g=function(){var e=Object(u.a)(l.a.mark((function e(a){var o,c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==n&&void 0!==n.current){e.next=2;break}return e.abrupt("return");case 2:return n.current.srcObject=a,e.next=5,s.joinRoom(r);case 5:for(c in null===(o=e.sent)&&(alert("This room does not exist."),t.history.push("/")),o.user)c!==s.userID()&&(i.current[c]=new y(c));s.onCallerMsg(r,"request-connect",function(){var e=Object(u.a)(l.a.mark((function e(t,n,r,o){var c,u;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n<r)){e.next=10;break}if(c=t[n++],void 0===i.current[o]&&(i.current[o]=new y(o)),u=i.current[o],"initiate"!==c){e.next=7;break}return e.next=7,s.sendCallerAResponse("callee-accept",o);case 7:u.processCallerPayload(a,o,c,(function(e){s.sendCallerAResponse(e,o)}),(function(e){m({})})),e.next=0;break;case 10:m({});case 11:case"end":return e.stop()}}),e)})));return function(t,n,r,a){return e.apply(this,arguments)}}()),s.onCalleeMsg(r,"response-signal",function(){var e=Object(u.a)(l.a.mark((function e(t,n,r,o){var c;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(;n<r;)c=t[n++],void 0===i.current[o]&&(i.current[o]=new y(o)),i.current[o].processCalleePayload(a,o,c,(function(e){s.sendCalleeAResponse(e,o)}),(function(e){m({})}));m({});case 2:case"end":return e.stop()}}),e)})));return function(t,n,r,a){return e.apply(this,arguments)}}()),h(a,o),m({});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),h=function(e,t){console.log({roomInfo:t});var n=t.user,a=s.userID(),o=s.firebaseTimeToTimestamp(n[a]);for(var c in console.log("current user joined room timestamp:",o),n){var i=s.firebaseTimeToTimestamp(n[c]);c!==a&&i<o&&v(c,e,r)}},v=function(e,t,n){s.initiateConnection(n,"initiate-connection",e)},x=[];for(var E in i.current)i.current[E].peer&&x.push(i.current[E].peer);var b={failed:"red",initiated:"orange","not-connected":"grey",connecting:"yellow",connected:"green"},T=i.current?Object.keys(i.current).map((function(e){return o.a.createElement("li",{key:e},"User ID: ",e," Status:"," ",o.a.createElement("span",{style:{backgroundColor:b[i.current[e].state]}},i.current[e].state))})):null;return console.log("peer list:",x),console.log(i.current),o.a.createElement("div",null,o.a.createElement("h3",null,"My User ID: ",s?s.userID():void 0),o.a.createElement("video",{muted:!0,ref:n,autoPlay:!0,playsInline:!0}),o.a.createElement("h3",null,"User In Room:"),o.a.createElement("ul",null,T),o.a.createElement("hr",null),x.map((function(e,t){return o.a.createElement("div",{key:t},t,o.a.createElement(w,{peer:e}))})))})),P=function(e){var t=Object(a.useState)(),n=Object(p.a)(t,2),r=n[0],c=n[1],s=Object(a.useState)(null),i=Object(p.a)(s,2),d=i[0],m=i[1];Object(a.useEffect)((function(){Object(u.a)(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,E();case 2:t=e.sent,c(t);case 4:case"end":return e.stop()}}),e)})))()}),[]);var h=function(){var e=Object(u.a)(l.a.mark((function e(){var t;return l.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.createRoom();case 2:t=e.sent,m("/room/".concat(t));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return o.a.createElement(g.a,{basename:"/"},o.a.createElement(o.a.StrictMode,null,o.a.createElement("button",{onClick:h},"Create Room"),d?o.a.createElement(f.a,{to:d}):void 0,o.a.createElement(f.d,null,o.a.createElement(f.b,{path:"/room/:id",component:function(){return o.a.createElement(_,Object.assign({},e,{connection:r}))}}))))};s.a.render(o.a.createElement(P,null),document.getElementById("root"))},49:function(e,t,n){e.exports=n(103)},54:function(e,t,n){},56:function(e,t,n){},80:function(e,t){},82:function(e,t){}},[[49,1,2]]]);
//# sourceMappingURL=main.d5d5aa14.chunk.js.map