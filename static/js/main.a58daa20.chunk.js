(this["webpackJsonppeer-to-peer-chat"]=this["webpackJsonppeer-to-peer-chat"]||[]).push([[0],{101:function(e,n,t){"use strict";t.r(n);var r=t(1),o=t.n(r),a=t(44),c=t.n(a),s=(t(52),t(24)),i=t(45),l=t(3),u=t.n(l),p=t(4),d=t(5),f=(t(54),t(23)),m=t(28),g=t.n(m),v=t(27),x={firestore:f.firestore,auth:f.auth,initializeApp:f.initializeApp},h=function(){var e=Object(p.a)(u.a.mark((function e(){var n,t,r,o,a,c,s,l,d;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n='"{"apiKey":"AIzaSyAHH_MAChQ_IBDZpr9-56HcHIB75DVVKH0","authDomain":"peer-to-peer-chat.firebaseapp.com","databaseURL":"https://peer-to-peer-chat.firebaseio.com","projectId":"peer-to-peer-chat","storageBucket":"peer-to-peer-chat.appspot.com","messagingSenderId":"445910441383","appId":"1:445910441383:web:8c62e1574f618d33c02a82","measurementId":"G-Z2GVLXMPT8"}"'.slice(1,-1),t=JSON.parse(n),x.initializeApp(t),r=x.firestore(),console.log("initializing firebase"),e.next=7,x.auth().signInAnonymously();case 7:return o=e.sent,console.log("user auth uid:",o.user.uid),e.next=11,r.collection("user").doc(o.user.uid).get();case 11:if(a=e.sent,console.log("==== user existing info ===="),console.log("user has existing info status:",a.exists),console.log("user existing info id:",a.id),console.log("user existing info:",a.data()),a&&a.exists){e.next=19;break}return e.next=19,r.collection("user").doc(o.user.uid).set({authenInfo:null,friendList:[],roomOwner:[],roomMemeber:[]});case 19:return e.next=21,r.collection("user").doc(o.user.uid);case 21:return c=e.sent,console.log("userRef:",c),console.log("userRef id:",c.id),s=function(e){var n=e.seconds,t=e.nanoseconds;return new x.firestore.Timestamp(n,t).toMillis()},l=function(){var e=Object(p.a)(u.a.mark((function e(n){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.doc("connection/".concat(n));case 2:return t=e.sent,e.next=5,r.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(n){var r,o,a,c,i,l,p,d,f,m,g,v,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(t);case 2:if(!(r=e.sent).exists){e.next=20;break}if(o=r.data(),a=o.callerPayload,c=o.from,i=o.lastUpdated,l=r.data(),p=l.callerMsgInd,d=l.callerMsgCnt,f=x.firestore.Timestamp.now().toMillis(),m=s(i),g=f-m>=3e4,console.log("incoming caller msg:",{callerPayload:a,callerMsgInd:p,callerMsgCnt:d,from:c,lastUpdateMili:m,currentTime:f,expired:g}),!(p>=d||g)){e.next=13;break}return console.log("no caller msg to process"),e.abrupt("return",null);case 13:for(v=Object.assign({},a),h=p;p<d;)delete a[p++];return console.log("updating remote copy:",{callerPayload:a,callerMsgInd:p}),e.next=19,n.update(t,{callerPayload:a,callerMsgInd:p,callerMsgDiff:d-p,lastUpdated:x.firestore.Timestamp.now().toDate()});case 19:return e.abrupt("return",{callerPayload:v,callerMsgInd:h,callerMsgCnt:d,from:c});case 20:return e.abrupt("return",null);case 21:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),d=function(){var e=Object(p.a)(u.a.mark((function e(n){var t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.doc("connection/".concat(n));case 2:return t=e.sent,e.next=5,r.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(n){var r,o,a,c,i,l,p,d,f,m,g,v,h;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n.get(t);case 2:if(!(r=e.sent).exists){e.next=20;break}if(o=r.data(),a=o.calleePayload,c=o.to,i=o.lastUpdated,l=r.data(),p=l.calleeMsgInd,d=l.calleeMsgCnt,f=x.firestore.Timestamp.now().toMillis(),m=s(i),g=f-m>=3e4,console.log("incoming callee msg:",{calleePayload:a,calleeMsgInd:p,calleeMsgCnt:d,to:c,lastUpdateMili:m,currentTime:f,expired:g}),!(p>=d||g)){e.next=13;break}return console.log("no callee msg to process"),e.abrupt("return",null);case 13:for(v=Object.assign({},a),h=p;p<d;)delete a[p++];return console.log("updating remote copy:",{calleePayload:a,calleeMsgInd:p}),e.next=19,n.update(t,{calleePayload:a,calleeMsgInd:p,calleeMsgDiff:d-p,lastUpdated:x.firestore.Timestamp.now().toDate()});case 19:return e.abrupt("return",{calleePayload:v,calleeMsgInd:h,calleeMsgCnt:d,to:c});case 20:return e.abrupt("return",null);case 21:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 5:return e.abrupt("return",e.sent);case 6:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),e.abrupt("return",{userID:function(){return c.id},userInfo:function(){},on:function(e,n,t){},onCallerMsg:function(e,n,t){r.collection("connection").where("roomID","==",e).where("to","==",c.id).where("callerMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(p.a)(u.a.mark((function e(n){var r,o,a,c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.exists){e.next=9;break}return e.next=3,l(n.id);case 3:if(!(r=e.sent)){e.next=9;break}return o=r.callerPayload,a=r.callerMsgInd,c=r.callerMsgCnt,s=r.from,console.log("processing payload:",{callerPayload:o,callerMsgInd:a,callerMsgCnt:c}),e.next=9,t(o,a,c,s);case 9:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}())}))},onCalleeMsg:function(e,n,t){r.collection("connection").where("roomID","==",e).where("from","==",c.id).where("calleeMsgDiff",">",0).onSnapshot((function(e){e.forEach(function(){var e=Object(p.a)(u.a.mark((function e(n){var r,o,a,c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.exists){e.next=8;break}return e.next=3,d(n.id);case 3:if(!(r=e.sent)){e.next=8;break}return o=r.calleePayload,a=r.calleeMsgInd,c=r.calleeMsgCnt,s=r.to,e.next=8,t(o,a,c,s);case 8:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}())}))},sendCallerAResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,t){var o,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[t,c.id].sort().join("_"),console.log("responding to caller:",t),console.log("connection id:",o),console.log({data:n}),e.next=6,r.doc("connection/".concat(o));case 6:return a=e.sent,e.next=9,r.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(t){var r,o,c,s,i,l;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(a);case 2:if(!(r=e.sent).exists){e.next=10;break}return o=r.data(),c=o.calleePayload,s=o.calleeMsgCnt,i=o.calleeMsgInd,l=x.firestore.FieldValue.increment((new TextEncoder).encode(JSON.stringify(n)).length),c[s]=n,s++,e.next=10,t.update(a,{calleeMsgCnt:s,calleePayload:c,calleeMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate(),payloadByteUsed:l});case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),sendCalleeAResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,t){var o,a;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[t,c.id].sort().join("_"),console.log("responding to callee:",t),console.log("connection id:",o),console.log({data:n}),e.next=6,r.doc("connection/".concat(o));case 6:return a=e.sent,e.next=9,r.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(t){var r,o,c,s,i,l;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.get(a);case 2:if(!(r=e.sent).exists){e.next=10;break}return o=r.data(),c=o.callerPayload,s=o.callerMsgCnt,i=o.callerMsgInd,l=x.firestore.FieldValue.increment((new TextEncoder).encode(JSON.stringify(n)).length),c[s]=n,s++,e.next=10,t.update(a,{callerMsgCnt:s,callerPayload:c,callerMsgDiff:s-i,lastUpdated:x.firestore.Timestamp.now().toDate(),payloadByteUsed:l});case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 9:case"end":return e.stop()}}),e)})));return function(n,t){return e.apply(this,arguments)}}(),initiateConnection:function(){var e=Object(p.a)(u.a.mark((function e(n,t,o){var a,s,i=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=[o,c.id].sort().join("_"),console.log("initiating connnection from:",c.id),console.log("connection id:",a),console.log({roomID:n,message:t,to:o,from:c.id}),e.next=7,r.doc("connection/".concat(a));case 7:return s=e.sent,e.next=10,r.runTransaction(function(){var e=Object(p.a)(u.a.mark((function e(r){var a,l,p,d,f;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get(s);case 2:if(a=e.sent,l=!0===a.exists?a.data():null,p=!1,l&&(d=i.firebaseTimeToTimestamp(l.lastUpdated),f=x.firestore.Timestamp.now().toMillis(),p=f-d>=3e4,console.log("prior control expire status:",p,", milisecond elapsed:",f-d)),null!==l&&!p){e.next=10;break}return console.log("creating new connection"),e.next=10,r.set(s,{from:c.id,to:o,roomID:n,message:t,callerMsgCnt:1,callerMsgInd:0,callerMsgDiff:1,callerPayload:{0:b},calleeMsgCnt:0,calleeMsgInd:0,calleeMsgDiff:0,calleePayload:{},payloadByteUsed:0,lastUpdated:x.firestore.Timestamp.now().toDate()});case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}());case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),console.error("msg send error:",e.t0);case 15:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(n,t,r){return e.apply(this,arguments)}}(),emit:function(){var e=Object(p.a)(u.a.mark((function e(n,t,r,o){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}(),respond:function(){var e=Object(p.a)(u.a.mark((function e(n,t,r,o){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}(),sendAndWaitForResponse:function(){var e=Object(p.a)(u.a.mark((function e(n,t,o,a){var s,i,l,p,d,f,m,g=arguments;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=g.length>4&&void 0!==g[4]?g[4]:5e3,console.log("creating message for:",c.id),console.log({roomID:n,message:t,payload:o,from:c.id,to:a,timeout:s}),e.prev=3,e.next=6,r.doc("msg-queue/".concat(c.id)).set({from:c.id,response:null,msgRead:!1,to:a,message:t,roomID:n,payload:o});case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("msg send error:",e.t0);case 11:return i="timeout",l=null,p=!0,d=new Promise((function(e,n){l=r.doc("msg-queue/".concat(c.id)).onSnapshot((function(n){var t=n.data(),r=t.msgRead,o=t.response;!0===r&&(l(),console.log("recieved response:",n.data()),p=!1,e(o))}))})),f=new Promise((function(e,n){return setTimeout((function(){p?(console.error("Promise Timeout"),console.log("unsub listener"),l(),n(i)):e()}),s)})),e.next=18,Promise.race([d,f]);case 18:return m=e.sent,e.abrupt("return",m);case 20:case"end":return e.stop()}}),e,null,[[3,8]])})));return function(n,t,r,o){return e.apply(this,arguments)}}(),joinRoom:function(){var e=Object(p.a)(u.a.mark((function e(n){var t,o,a,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("joining room:",n),!n){e.next=23;break}return e.next=5,r.doc("room/".concat(n));case 5:return t=e.sent,e.next=8,t.get();case 8:if(!(o=e.sent)||!o.exists){e.next=22;break}return console.log("userRef in room:",c.id),a=Object(i.a)({},"user."+c.id,x.firestore.Timestamp.now().toDate()),console.log("room data:",o.data()),console.log("msg queue data:",a),e.next=16,t.update(a);case 16:return e.next=18,t.get();case 18:return s=e.sent,e.abrupt("return",s.data());case 22:console.log("room doesn't exist:",n);case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(0),console.error("join room exception:",e.t0);case 28:return e.abrupt("return",null);case 29:case"end":return e.stop()}}),e,null,[[0,25]])})));return function(n){return e.apply(this,arguments)}}(),createRoom:function(){var e=Object(p.a)(u.a.mark((function e(){var n,t;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.collection("room").add({user:{},created:x.firestore.Timestamp.now().toDate()});case 3:return n=e.sent,e.next=6,c.update({roomOwner:x.firestore.FieldValue.arrayUnion(n.id)});case 6:return t=e.sent,console.log("create room id:",n.id),console.log("create room info:",t),e.abrupt("return",n.id);case 12:e.prev=12,e.t0=e.catch(0),console.error("create room exception:",e.t0);case 15:return e.abrupt("return",null);case 16:case"end":return e.stop()}}),e,null,[[0,12]])})));return function(){return e.apply(this,arguments)}}(),firebaseTimeToTimestamp:s});case 28:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),b="initiate",w=function(e){this.id=e,this.state="not-connected",this.peer=null},y=function(e){var n=Object(r.useRef)();return Object(r.useEffect)((function(){e.peer.on("stream",(function(e){console.log("peer stream:",e),n.current.srcObject=e}))}),[]),o.a.createElement("div",null,o.a.createElement("video",{playsInline:!0,autoPlay:!0,ref:n}))},M=Object(d.g)((function(e){var n=Object.assign({},e),t=Object(r.useRef)(),a=n.match.params.id,c={height:window.innerHeight/2,width:window.innerWidth/2};console.log("roomID--\x3e",a,"props --\x3e",n);var i=n.userDB,l=Object(r.useRef)(),d=Object(r.useState)({}),f=Object(s.a)(d,2),m=f[0],v=f[1];Object(r.useEffect)((function(){void 0!==i&&(void 0===l.current&&(l.current={}),navigator.mediaDevices.getUserMedia({video:c,audio:!1}).then(x))}),[]);var x=function(){var e=Object(p.a)(u.a.mark((function e(r){var o,c;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.current.srcObject=r,e.next=3,i.joinRoom(a);case 3:for(c in null===(o=e.sent)&&(alert("This room does not exist."),n.history.push("/")),o.user)c!==i.userID()&&(l.current[c]=new w(c));v({}),i.onCallerMsg(a,"request-connect",function(){var e=Object(p.a)(u.a.mark((function e(n,t,o,a){var c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t<o)){e.next=14;break}if(c=n[t++],void 0===l.current[a]&&(l.current[a]=new w(a)),"not-connected"!==(s=l.current[a]).state||c!==b){e.next=11;break}return s.state="initiated",console.log("initiation recieved from:",a),e.next=9,i.sendCallerAResponse("callee-accept",a);case 9:e.next=12;break;case 11:"initiated"===s.state?(s.state="connecting",console.log("recieved offer recieved from:",a),console.log("offer:",c),s.peer=j(c,a,r,(function(e){i.sendCallerAResponse(e,a)})),s.peer.on("connect",(function(){console.log("connection connected:",l.current[a].id),l.current[a].state="connected",v({})})),s.peer.on("close",(function(){l.current[a].state="not-connected",console.log("connection closed:",l.current[a].id),l.current[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})})),s.peer.on("error",(function(e){console.log("connection error:",l.current[a].id,e),l.current[a].state="failed",l.current[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})})),s.peer.signal(c)):"connecting"===s.state||"connected"===s.state?(console.log("recieved ICE recieved from:",a),console.log("ICE:",c),s.peer.signal(c)):(s.state="failed",s.peer&&(s.peer.destroy(),s.peer=void 0));case 12:e.next=0;break;case 14:v({});case 15:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}()),i.onCalleeMsg(a,"response-signal",function(){var e=Object(p.a)(u.a.mark((function e(n,t,o,a){var c,s;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(;t<o;)c=n[t++],void 0===l.current[a]&&(l.current[a]=new w(a)),"not-connected"===(s=l.current[a]).state&&"callee-accept"===c?(s.state="initiated",console.log("callee accepted call:",a),s.peer=k(a,r,(function(e){i.sendCalleeAResponse(e,a)})),s.peer.on("connect",(function(){l.current[a].state="connected",console.log("connection connect:",l.current[a].id),v({})})),s.peer.on("close",(function(){console.log("connection cosed:",l.current[a].id),l.current[a].state="not-connected",l.current[a].peer&&(m[a].peer.destroy(),m[a].peer=void 0),v({})})),s.peer.on("error",(function(e){console.log("connection error:",l.current[a].id,e),l.current[a].state="failed",l.currentom[a].peer&&(l.current[a].peer.destroy(),l.current[a].peer=void 0),v({})}))):"initiated"===s.state||"connecting"===s.state||"connected"===s.state?("initiated"===s.state&&(s.state="connecting"),console.log("recieved answer/ICE recieved from callee:",a),console.log("callee data:",c),s.peer.signal(c)):(s.state="failed",s.peer&&(s.peer.destroy(),s.peer=void 0));v({});case 2:case"end":return e.stop()}}),e)})));return function(n,t,r,o){return e.apply(this,arguments)}}()),h(r,o);case 10:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),h=function(e,n){console.log({roomInfo:n});var t=n.user,r=i.userID(),o=i.firebaseTimeToTimestamp(t[r]);for(var c in console.log("current user joined room timestamp:",o),t){var s=i.firebaseTimeToTimestamp(t[c]);c!==r&&s<o&&M(c,e,a)}},M=function(e,n,t){i.initiateConnection(t,"initiate-connection",e)},k=function(e,n,t){var r=new g.a({initiator:!0,trickle:!1,stream:n});return console.log("peer created --\x3e",r),r.on("signal",(function(n){console.log("signal created for:",e,n),t(n)})),r},j=function(e,n,t,r){var o=new g.a({initiator:!1,trickle:!1,stream:t});return o.on("signal",(function(e){console.log("returning signal created for",n,e),r(e)})),o},O=[];for(var I in l.current)l.current[I].peer&&O.push(l.current[I].peer);var T={failed:"red",initiated:"orange","not-connected":"grey",connecting:"yellow",connected:"green"},D=l.current?Object.keys(l.current).map((function(e){return o.a.createElement("li",{key:e},"User ID: ",e," Status:"," ",o.a.createElement("span",{style:{backgroundColor:T[l.current[e].state]}},l.current[e].state))})):null;return console.log("peer list:",O),console.log(l.current),o.a.createElement("div",null,o.a.createElement("h3",null,"My User ID: ",i?i.userID():void 0),o.a.createElement("video",{muted:!0,ref:t,autoPlay:!0,playsInline:!0}),o.a.createElement("h3",null,"User In Room:"),o.a.createElement("ul",null,D),o.a.createElement("hr",null),O.map((function(e,n){return o.a.createElement("div",{key:n},n,o.a.createElement(y,{peer:e}))})))})),k=function(e){var n=Object(r.useState)(),t=Object(s.a)(n,2),a=t[0],c=t[1],i=Object(r.useState)(null),l=Object(s.a)(i,2),f=l[0],m=l[1];Object(r.useEffect)((function(){Object(p.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h();case 2:n=e.sent,c(n);case 4:case"end":return e.stop()}}),e)})))()}),[]);var g=function(){var e=Object(p.a)(u.a.mark((function e(){var n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.createRoom();case 2:n=e.sent,m("/room/".concat(n));case 4:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return o.a.createElement(v.a,{basename:"/"},o.a.createElement(o.a.StrictMode,null,o.a.createElement("button",{onClick:g},"Create Room"),f?o.a.createElement(d.a,{to:f}):void 0,o.a.createElement(d.d,null,o.a.createElement(d.b,{path:"/room/:id",component:function(){return o.a.createElement(M,Object.assign({},e,{userDB:a}))}}))))};c.a.render(o.a.createElement(k,null),document.getElementById("root"))},47:function(e,n,t){e.exports=t(101)},52:function(e,n,t){},54:function(e,n,t){},88:function(e,n){},90:function(e,n){}},[[47,1,2]]]);
//# sourceMappingURL=main.a58daa20.chunk.js.map